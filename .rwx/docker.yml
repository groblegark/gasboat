# OCI image builds for gasboat services — crane-based push to GHCR.
#
# Architecture:
#   build-* tasks     -> compile binaries as artifacts (cached by filters)
#   download-* tasks  -> fetch external deps as cached artifacts
#   push-*  tasks     -> crane-append layers to ubuntu:24.04, push to GHCR
#
# Images produced:
#   push-controller    -> ghcr.io/groblegark/gasboat/controller
#   push-agent         -> ghcr.io/groblegark/gasboat/agent (omnibus)
#   push-slack-bridge  -> ghcr.io/groblegark/gasboat/slack-bridge
#   push-jira-bridge   -> ghcr.io/groblegark/gasboat/jira-bridge
#
# For manual push of a single image:
#   rwx run .rwx/docker.yml --init commit-sha=$(git rev-parse HEAD) --target push-agent
#
# OPTIMIZATIONS:
# - Filter directives on Go mod downloads (cached by go.mod/go.sum)
# - Parallel builds with filter caching for dependency stability

on:
  github:
    push:
      if: ${{ event.git.branch == 'main' || starts-with(event.git.tag, '20') }}
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.git.ref }}
        coop-version: latest
        kd-version: latest
      status-checks:
        name: Docker
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: pr
        coop-version: latest
        kd-version: latest
      status-checks:
        - tasks: [build-controller, build-gb, build-slack-bridge, build-jira-bridge, download-coop, download-kd]
          name: Docker
  dispatch:
    - key: gasboat-agent-rebuild
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.dispatch.params.trigger-source }}
        coop-version: ${{ event.dispatch.params.coop-version }}
        kd-version: ${{ event.dispatch.params.kd-version }}
      params:
        - key: trigger-source
          name: Trigger source
          description: What triggered the rebuild (e.g. coop-release, beads-release)
          default: manual
          required: false
        - key: coop-version
          name: Coop version
          description: Coop release tag to pin (e.g. 2026.056.0). Defaults to latest.
          default: latest
          required: false
        - key: kd-version
          name: Beads/kd version
          description: Beads release tag to pin (e.g. 2026.056.0). Defaults to latest.
          default: latest
          required: false
      title: Agent rebuild (${{ init.ref-name }})
      target: push-agent
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      ref-name: cli
      coop-version: latest
      kd-version: latest

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  # ═══════════════════════════════════════════════════════════════════════
  # Build tasks — compile and download in parallel, output binary artifacts
  # ═══════════════════════════════════════════════════════════════════════

  # ── Clone gasboat repo ─────────────────────────────────────────────
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/gasboat.git
      ref: ${{ init.commit-sha }}

  # ── Go toolchain ───────────────────────────────────────────────────
  - key: go
    call: golang/install 1.2.0
    with:
      go-version: "1.25"

  # ── Controller Go mod download (cached by go.mod/go.sum) ──────────
  - key: go-deps
    use: [code, go]
    run: cd controller && go mod download
    filter:
      - controller/go.mod
      - controller/go.sum

  # ── Build controller binary → artifact ─────────────────────────────
  - key: build-controller
    use: go-deps
    run: |
      cd controller
      REF_NAME="${REF_NAME#refs/tags/}"
      REF_NAME="${REF_NAME#refs/heads/}"
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w -X main.version=${REF_NAME} -X main.commit=${COMMIT_SHA}" \
        -o ../controller-bin ./cmd/controller/
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    outputs:
      artifacts:
        - key: controller-binary
          path: controller-bin

  # ── Build gb CLI binary → artifact ─────────────────────────────────
  - key: build-gb
    use: go-deps
    run: |
      cd controller
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w" \
        -o ../gb ./cmd/gb/
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    outputs:
      artifacts:
        - key: gb-binary
          path: gb

  # ── Build slack-bridge binary → artifact ───────────────────────────
  - key: build-slack-bridge
    use: go-deps
    run: |
      cd controller
      REF_NAME="${REF_NAME#refs/tags/}"
      REF_NAME="${REF_NAME#refs/heads/}"
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w -X main.version=${REF_NAME} -X main.commit=${COMMIT_SHA}" \
        -o ../slack-bridge ./cmd/slack-bridge/
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    outputs:
      artifacts:
        - key: slack-bridge-binary
          path: slack-bridge

  # ── Build jira-bridge binary → artifact ────────────────────────────
  - key: build-jira-bridge
    use: go-deps
    run: |
      cd controller
      REF_NAME="${REF_NAME#refs/tags/}"
      REF_NAME="${REF_NAME#refs/heads/}"
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w -X main.version=${REF_NAME} -X main.commit=${COMMIT_SHA}" \
        -o ../jira-bridge ./cmd/jira-bridge/
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    outputs:
      artifacts:
        - key: jira-bridge-binary
          path: jira-bridge

  # ── Download coop from releases → artifact (parallel, cached) ──────
  - key: download-coop
    run: |
      set -ex
      COOP_VER="${COOP_VERSION:-latest}"
      if [ "$COOP_VER" = "latest" ] || [ -z "$COOP_VER" ]; then
        COOP_VER=$(curl -fsSL https://api.github.com/repos/groblegark/coop/releases/latest | jq -r .tag_name)
      fi
      echo "Downloading coop ${COOP_VER} for linux-amd64"
      curl -fsSL "https://github.com/groblegark/coop/releases/download/${COOP_VER}/coop-linux-amd64.tar.gz" \
        -o /tmp/coop.tar.gz
      mkdir -p coop-bin
      tar -xzf /tmp/coop.tar.gz -C coop-bin
      ls -la coop-bin/
    env:
      COOP_VERSION: ${{ init.coop-version }}
    filter:
      - .rwx/cache-config.lock
    outputs:
      artifacts:
        - key: coop-binaries
          path: coop-bin

  # ── Download kd from releases → artifact (parallel, cached) ────────
  - key: download-kd
    run: |
      set -ex
      KD_VER="${KD_VERSION:-latest}"
      if [ "$KD_VER" = "latest" ] || [ -z "$KD_VER" ]; then
        KD_VER=$(curl -fsSL https://api.github.com/repos/groblegark/kbeads/releases/latest | jq -r .tag_name)
      fi
      VERSION_NUM=${KD_VER#v}
      echo "Downloading kd ${KD_VER} for linux_amd64"
      curl -fsSL "https://github.com/groblegark/kbeads/releases/download/${KD_VER}/kd-linux-x86_64.tar.gz" \
        -o /tmp/kd.tar.gz
      mkdir -p kd-bin
      tar -xzf /tmp/kd.tar.gz -C kd-bin
      ls -la kd-bin/
    env:
      KD_VERSION: ${{ init.kd-version }}
    filter:
      - .rwx/cache-config.lock
    outputs:
      artifacts:
        - key: kd-binaries
          path: kd-bin

  # ═══════════════════════════════════════════════════════════════════════
  # Push tasks — crane-append layers to ubuntu:24.04, push to GHCR.
  # Each push task builds a minimal OCI layer and pushes directly.
  # ═══════════════════════════════════════════════════════════════════════

  # ── Push controller (minimal static binary) ──────────────────────────
  - key: push-controller
    use: [build-controller]
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    run: |
      set -ex
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      # Install crane
      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/

      # Login to GHCR
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      # Build layer: static binary + CA certs
      mkdir -p /tmp/layer/etc/ssl/certs
      cp ${{ tasks.build-controller.artifacts.controller-binary }} /tmp/layer/controller
      chmod 755 /tmp/layer/controller
      cp /etc/ssl/certs/ca-certificates.crt /tmp/layer/etc/ssl/certs/
      tar -cf /tmp/layer.tar -C /tmp/layer .

      # Push
      REPO="ghcr.io/groblegark/gasboat/controller"
      crane append --base ubuntu:24.04 --new_tag "${REPO}:${TAG}" --new_layer /tmp/layer.tar --platform linux/amd64
      crane mutate "${REPO}:${TAG}" --entrypoint /controller --user nobody -t "${REPO}:${TAG}"
      crane tag "${REPO}:${TAG}" latest
      echo "Pushed ${REPO}:${TAG} and ${REPO}:latest"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── Push slack-bridge (minimal static binary) ────────────────────────
  - key: push-slack-bridge
    use: [build-slack-bridge]
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    run: |
      set -ex
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      mkdir -p /tmp/layer/etc/ssl/certs
      cp ${{ tasks.build-slack-bridge.artifacts.slack-bridge-binary }} /tmp/layer/slack-bridge
      chmod 755 /tmp/layer/slack-bridge
      cp /etc/ssl/certs/ca-certificates.crt /tmp/layer/etc/ssl/certs/
      tar -cf /tmp/layer.tar -C /tmp/layer .

      REPO="ghcr.io/groblegark/gasboat/slack-bridge"
      crane append --base ubuntu:24.04 --new_tag "${REPO}:${TAG}" --new_layer /tmp/layer.tar --platform linux/amd64
      crane mutate "${REPO}:${TAG}" --entrypoint /slack-bridge --user nobody -t "${REPO}:${TAG}"
      crane tag "${REPO}:${TAG}" latest
      echo "Pushed ${REPO}:${TAG} and ${REPO}:latest"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── Push jira-bridge (minimal static binary) ─────────────────────────
  - key: push-jira-bridge
    use: [build-jira-bridge]
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    run: |
      set -ex
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      mkdir -p /tmp/layer/etc/ssl/certs
      cp ${{ tasks.build-jira-bridge.artifacts.jira-bridge-binary }} /tmp/layer/jira-bridge
      chmod 755 /tmp/layer/jira-bridge
      cp /etc/ssl/certs/ca-certificates.crt /tmp/layer/etc/ssl/certs/
      tar -cf /tmp/layer.tar -C /tmp/layer .

      REPO="ghcr.io/groblegark/gasboat/jira-bridge"
      crane append --base ubuntu:24.04 --new_tag "${REPO}:${TAG}" --new_layer /tmp/layer.tar --platform linux/amd64
      crane mutate "${REPO}:${TAG}" --entrypoint /jira-bridge --user nobody -t "${REPO}:${TAG}"
      crane tag "${REPO}:${TAG}" latest
      echo "Pushed ${REPO}:${TAG} and ${REPO}:latest"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── Push agent (omnibus: full dev toolchain) ─────────────────────────
  # Single image with everything an agent needs: git, Node, Claude Code,
  # Go, Rust, CLIs, dev tools, gb, coop, kd. No separate slim variant.
  - key: push-agent
    use: [code, build-gb, download-coop, download-kd]
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    timeout: 30m
    run: |
      set -e
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"
      export DEBIAN_FRONTEND=noninteractive

      # Install crane
      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/

      # Login to GHCR
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      LAYER=/tmp/layer
      mkdir -p $LAYER/usr/local/bin $LAYER/usr/local/go $LAYER/usr/bin $LAYER/etc

      # ── System packages (install on build VM, copy to layer) ─────────
      echo "=== Installing system packages ==="
      sudo apt-get -y update
      sudo apt-get -y install --no-install-recommends \
        curl git git-lfs jq xz-utils ca-certificates screen \
        openssh-client sudo \
        python3 python3-pip python3-venv \
        make unzip \
        gcc g++ libc6-dev binutils \
        pkg-config libssl-dev \
        libcurl3t64-gnutls libicu74 libicu-dev \
        postgresql-client shellcheck

      echo "=== Copying package files to layer ==="
      for pkg in git git-man git-lfs curl jq screen ca-certificates xz-utils \
          openssh-client sudo libapparmor1 \
          python3 python3-minimal python3.12 python3.12-minimal \
          python3-pip python3-venv python3.12-venv \
          libpython3.12-stdlib libpython3.12-minimal \
          make gcc g++ unzip binutils shellcheck \
          gcc-14 g++-14 cpp-14 libgcc-14-dev \
          libc6-dev linux-libc-dev binutils-x86-64-linux-gnu \
          pkg-config libssl-dev \
          libcurl4t64 libcurl3t64-gnutls \
          libnghttp2-14 libbrotli1 libpsl5t64 libonig5 libexpat1 \
          libicu74 libicu-dev icu-devtools \
          postgresql-client libpq5; do
        dpkg -L "$pkg" 2>/dev/null | while read -r f; do
          [ -f "$f" ] || continue
          dir="$LAYER$(dirname "$f")"
          mkdir -p "$dir"
          cp "$f" "$LAYER${f}" 2>/dev/null || true
        done || true
      done

      echo "=== Copying shared libs ==="
      for bin in /usr/bin/git /usr/bin/curl /usr/bin/jq /usr/bin/screen \
          /usr/bin/python3 /usr/bin/ssh /usr/bin/make /usr/bin/gcc \
          /usr/bin/sudo /usr/bin/psql; do
        [ -f "$bin" ] || continue
        ldd "$bin" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read -r lib; do
          [ -f "$lib" ] || continue
          dir="$LAYER$(dirname "$lib")"
          mkdir -p "$dir"
          cp -n "$lib" "$LAYER${lib}" 2>/dev/null || true
        done || true
      done

      echo "=== Copying gcc internals ==="
      find /usr/libexec/gcc -name 'cc1*' -o -name 'lto1' 2>/dev/null | while read -r bin; do
        ldd "$bin" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read -r lib; do
          [ -f "$lib" ] || continue
          dir="$LAYER$(dirname "$lib")"
          mkdir -p "$dir"
          cp -n "$lib" "$LAYER${lib}" 2>/dev/null || true
        done || true
      done || true

      echo "=== Copying ICU, headers, misc libs ==="
      # ICU data and libs
      find /usr/lib/x86_64-linux-gnu -name 'libicu*.so*' 2>/dev/null | while read -r f; do
        dir="$LAYER$(dirname "$f")"
        mkdir -p "$dir"
        cp -a "$f" "$LAYER${f}" 2>/dev/null || true
      done || true
      # ICU development headers
      if [ -d /usr/include/unicode ]; then
        mkdir -p $LAYER/usr/include/unicode
        cp -a /usr/include/unicode/* $LAYER/usr/include/unicode/ 2>/dev/null || true
      fi
      # C++ standard library headers (needed by ICU regex)
      for d in /usr/include/c++/14 /usr/include/c++/13; do
        if [ -d "$d" ]; then
          mkdir -p "$LAYER$d"
          cp -a "$d"/* "$LAYER$d/" 2>/dev/null || true
          target_dir="/usr/include/x86_64-linux-gnu/c++/$(basename $d)"
          if [ -d "$target_dir" ]; then
            mkdir -p "$LAYER$target_dir"
            cp -a "$target_dir"/* "$LAYER$target_dir/" 2>/dev/null || true
          fi
          break
        fi
      done
      # ICU pkg-config files
      find /usr/lib/x86_64-linux-gnu/pkgconfig -name 'icu*.pc' 2>/dev/null | while read -r f; do
        dir="$LAYER$(dirname "$f")"
        mkdir -p "$dir"
        cp "$f" "$LAYER${f}" 2>/dev/null || true
      done || true
      # git-core helpers (git-remote-https, etc.)
      cp -r /usr/lib/git-core $LAYER/usr/lib/ 2>/dev/null || true
      # gcc internal executables
      if [ -d /usr/libexec/gcc ]; then
        mkdir -p $LAYER/usr/libexec
        cp -r /usr/libexec/gcc $LAYER/usr/libexec/ 2>/dev/null || true
      fi
      # binutils (as, ld, ar, nm)
      for bin in /usr/bin/x86_64-linux-gnu-as /usr/bin/x86_64-linux-gnu-ld /usr/bin/as /usr/bin/ld; do
        [ -f "$bin" ] || continue
        ldd "$bin" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read -r lib; do
          [ -f "$lib" ] || continue
          dir="$LAYER$(dirname "$lib")"
          mkdir -p "$dir"
          cp -n "$lib" "$LAYER${lib}" 2>/dev/null || true
        done || true
      done
      # glibc linker scripts reference /lib/ paths but files live in /usr/lib/
      for script in /usr/lib/x86_64-linux-gnu/libc.so /usr/lib/x86_64-linux-gnu/libm.so; do
        [ -f "$script" ] || continue
        grep -oP '/lib/x86_64-linux-gnu/\S+' "$script" 2>/dev/null | tr -d ')' | while read -r ref; do
          [ -f "$LAYER$ref" ] && continue
          src="/usr${ref}"
          [ -f "$src" ] || src="$ref"
          [ -f "$src" ] || continue
          mkdir -p "$LAYER$(dirname "$ref")"
          cp "$src" "$LAYER$ref" 2>/dev/null || true
        done || true
      done
      # gcc support libraries (crtbegin.o, libgcc.a, etc.)
      for d in /usr/lib/gcc/x86_64-linux-gnu/14 /usr/lib/gcc/x86_64-linux-gnu/13; do
        if [ -d "$d" ]; then
          mkdir -p "$LAYER$d"
          cp -a "$d"/* "$LAYER$d/" 2>/dev/null || true
          break
        fi
      done
      # libcurl-gnutls symlinks (git-remote-https)
      find /usr/lib/x86_64-linux-gnu -name 'libcurl-gnutls*' 2>/dev/null | while read -r f; do
        dir="$LAYER$(dirname "$f")"
        mkdir -p "$dir"
        cp -a "$f" "$LAYER${f}" 2>/dev/null || true
      done || true
      # sudo helper libraries
      mkdir -p $LAYER/usr/libexec/sudo
      cp /usr/libexec/sudo/*.so* $LAYER/usr/libexec/sudo/ 2>/dev/null || true
      # Python symlink
      ln -sf python3 $LAYER/usr/bin/python

      # Sudoers config
      sudo mkdir -p $LAYER/etc/sudoers.d
      printf 'Defaults   env_reset\nDefaults   secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/go/bin"\nroot ALL=(ALL:ALL) ALL\n#includedir /etc/sudoers.d\n' | sudo tee $LAYER/etc/sudoers > /dev/null
      sudo chmod 0440 $LAYER/etc/sudoers
      printf 'agent ALL=(ALL) NOPASSWD: ALL\n' | sudo tee $LAYER/etc/sudoers.d/agent > /dev/null
      sudo chmod 0440 $LAYER/etc/sudoers.d/agent
      sudo cp /etc/sudo.conf $LAYER/etc/sudo.conf 2>/dev/null || true

      echo "=== Installing Node.js ==="
      # ── Node.js v24 ──────────────────────────────────────────────────
      NODE_FULL=$(curl -fsSL "https://nodejs.org/dist/index.json" \
        | jq -r '[.[] | select(.version | startswith("v24."))][0].version')
      [ "${NODE_FULL}" != "null" ] && [ -n "${NODE_FULL}" ] && \
      curl -fsSL "https://nodejs.org/dist/${NODE_FULL}/node-${NODE_FULL}-linux-x64.tar.xz" \
        | tar -xJ --strip-components=1 -C $LAYER/usr/local

      # ── Claude Code ──────────────────────────────────────────────────
      PATH="$LAYER/usr/local/bin:$PATH" npm install -g --prefix $LAYER/usr/local @anthropic-ai/claude-code

      # ── kubectl ──────────────────────────────────────────────────────
      KUBECTL_VERSION=$(curl -fsSL https://dl.k8s.io/release/stable.txt)
      curl -fsSL "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl" \
        -o $LAYER/usr/local/bin/kubectl
      chmod +x $LAYER/usr/local/bin/kubectl

      echo "=== Installing Go + gopls ==="
      # ── Go + gopls ──────────────────────────────────────────────────
      GO_LATEST=$(curl -fsSL "https://go.dev/dl/?mode=json" \
        | jq -r '[.[] | select(.version | startswith("go1.25"))][0].version')
      curl -fsSL "https://go.dev/dl/${GO_LATEST}.linux-amd64.tar.gz" | tar -C $LAYER/usr/local -xz
      GOROOT=$LAYER/usr/local/go GOPATH=/tmp/gopath $LAYER/usr/local/go/bin/go install golang.org/x/tools/gopls@latest 2>/dev/null || true
      cp /tmp/gopath/bin/gopls $LAYER/usr/local/go/bin/ 2>/dev/null || true
      chmod -R u+w /tmp/gopath 2>/dev/null || true
      rm -rf /tmp/gopath
      ln -sf /usr/local/go/bin/go $LAYER/usr/local/bin/go
      ln -sf /usr/local/go/bin/gofmt $LAYER/usr/local/bin/gofmt
      ln -sf /usr/local/go/bin/gopls $LAYER/usr/local/bin/gopls

      echo "=== Installing Rust toolchain ==="
      # ── Rust toolchain ──────────────────────────────────────────────
      export RUSTUP_HOME=$LAYER/usr/local/rustup CARGO_HOME=$LAYER/usr/local/cargo
      curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs \
        | sh -s -- -y --default-toolchain stable --profile default \
            --component rust-analyzer
      chmod -R a+rw $LAYER/usr/local/rustup $LAYER/usr/local/cargo

      # ── Rust Analyzer (standalone LSP) ──────────────────────────────
      curl -fsSL "https://github.com/rust-lang/rust-analyzer/releases/latest/download/rust-analyzer-x86_64-unknown-linux-gnu.gz" \
        | gunzip > $LAYER/usr/local/bin/rust-analyzer
      chmod +x $LAYER/usr/local/bin/rust-analyzer

      # ── GitHub CLI ──────────────────────────────────────────────────
      GH_VERSION=$(curl -fsSL "https://api.github.com/repos/cli/cli/releases/latest" \
        | jq -r .tag_name | sed "s/^v//")
      curl -fsSL "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz" \
        | tar -xz --strip-components=2 -C $LAYER/usr/local/bin "gh_${GH_VERSION}_linux_amd64/bin/gh"

      # ── GitLab CLI ──────────────────────────────────────────────────
      GLAB_VERSION=$(curl -fsSL "https://gitlab.com/api/v4/projects/gitlab-org%2Fcli/releases" \
        | jq -r '.[0].tag_name | ltrimstr("v")')
      curl -fsSL "https://gitlab.com/gitlab-org/cli/-/releases/v${GLAB_VERSION}/downloads/glab_${GLAB_VERSION}_linux_amd64.tar.gz" \
        | tar -xz --strip-components=1 -C $LAYER/usr/local/bin bin/glab

      # ── Docker CLI (client only) ────────────────────────────────────
      curl -fsSL "https://download.docker.com/linux/static/stable/x86_64/docker-27.5.1.tgz" \
        | tar -xz --strip-components=1 -C $LAYER/usr/local/bin docker/docker

      # ── AWS CLI ─────────────────────────────────────────────────────
      curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscli.zip
      unzip -q /tmp/awscli.zip -d /tmp
      /tmp/aws/install --install-dir /tmp/aws-install --bin-dir /tmp/aws-bin
      mkdir -p $LAYER/opt/aws-cli
      cp -r /tmp/aws-install/* $LAYER/opt/aws-cli/
      rm -rf $LAYER/opt/aws-cli/v2/current
      AWS_VER=$(ls $LAYER/opt/aws-cli/v2/ | head -1)
      ln -sf "$AWS_VER" $LAYER/opt/aws-cli/v2/current
      rm -rf $LAYER/opt/aws-cli/bin
      mkdir -p $LAYER/opt/aws-cli/bin
      ln -sf /opt/aws-cli/v2/current/bin/aws $LAYER/opt/aws-cli/bin/aws
      ln -sf /opt/aws-cli/v2/current/bin/aws_completer $LAYER/opt/aws-cli/bin/aws_completer
      ln -sf /opt/aws-cli/v2/current/bin/aws $LAYER/usr/local/bin/aws
      rm -rf /tmp/awscli.zip /tmp/aws /tmp/aws-install /tmp/aws-bin

      # ── RWX CLI ─────────────────────────────────────────────────────
      curl -fsSL "https://github.com/rwx-cloud/cli/releases/latest/download/rwx-linux-x86_64" \
        -o $LAYER/usr/local/bin/rwx
      chmod +x $LAYER/usr/local/bin/rwx

      # ── Claudeless (Claude CLI simulator) ───────────────────────────
      curl -fsSL "https://github.com/alfredjeanlab/claudeless/releases/download/v0.4.0/claudeless-linux-x86_64.tar.gz" \
        | tar -xz -C $LAYER/usr/local/bin claudeless
      chmod +x $LAYER/usr/local/bin/claudeless

      # ── uv (Python package manager) ─────────────────────────────────
      curl -LsSf https://astral.sh/uv/install.sh | env INSTALLER_NO_MODIFY_PATH=1 sh
      mv ~/.local/bin/uv $LAYER/usr/local/bin/uv
      mv ~/.local/bin/uvx $LAYER/usr/local/bin/uvx

      # ── Bun ─────────────────────────────────────────────────────────
      BUN_INSTALL=$LAYER/usr/local/bun curl -fsSL https://bun.sh/install | bash
      ln -sf /usr/local/bun/bin/bun $LAYER/usr/local/bin/bun
      ln -sf /usr/local/bun/bin/bunx $LAYER/usr/local/bin/bunx

      # ── Task CLI (Taskfile runner) ──────────────────────────────────
      GOROOT=$LAYER/usr/local/go GOPATH=/tmp/gopath $LAYER/usr/local/go/bin/go install github.com/go-task/task/v3/cmd/task@latest
      mv /tmp/gopath/bin/task $LAYER/usr/local/bin/task
      chmod -R u+w /tmp/gopath 2>/dev/null || true
      rm -rf /tmp/gopath

      # ── Helm + plugins ──────────────────────────────────────────────
      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | sudo bash
      cp /usr/local/bin/helm $LAYER/usr/local/bin/helm
      HELM_DATA_HOME=$LAYER/usr/local/share/helm helm plugin install https://github.com/helm-unittest/helm-unittest
      HELM_DATA_HOME=$LAYER/usr/local/share/helm helm plugin install https://github.com/chartmuseum/helm-push

      # ── Terraform + Terragrunt ──────────────────────────────────────
      TERRAFORM_VERSION=1.11.3
      TERRAGRUNT_VERSION=0.77.11
      curl -fsSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" \
        -o /tmp/terraform.zip
      unzip -q /tmp/terraform.zip -d $LAYER/usr/local/bin
      rm /tmp/terraform.zip
      curl -fsSL "https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64" \
        -o $LAYER/usr/local/bin/terragrunt
      chmod +x $LAYER/usr/local/bin/terragrunt

      # ── golangci-lint ───────────────────────────────────────────────
      curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh \
        | sh -s -- -b $LAYER/usr/local/bin "v1.64.8"

      # ── quench (code quality checker) ───────────────────────────────
      PATH="$LAYER/usr/local/cargo/bin:$PATH" cargo install quench \
        --git https://github.com/alfredjeanlab/quench --root /tmp/quench-out
      cp /tmp/quench-out/bin/quench $LAYER/usr/local/bin/quench
      rm -rf /tmp/quench-out

      # ── yq (YAML processor) ─────────────────────────────────────────
      YQ_VERSION=$(curl -fsSL "https://api.github.com/repos/mikefarah/yq/releases/latest" | jq -r .tag_name)
      curl -fsSL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" \
        -o $LAYER/usr/local/bin/yq
      chmod +x $LAYER/usr/local/bin/yq

      # ── stern (K8s log streaming) ───────────────────────────────────
      STERN_VERSION=1.30.0
      curl -fsSL "https://github.com/stern/stern/releases/download/v${STERN_VERSION}/stern_${STERN_VERSION}_linux_amd64.tar.gz" \
        | tar -xz -C $LAYER/usr/local/bin stern

      # ── hadolint (Dockerfile linter) ────────────────────────────────
      curl -fsSL "https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64" \
        -o $LAYER/usr/local/bin/hadolint
      chmod +x $LAYER/usr/local/bin/hadolint

      echo "=== Installing Playwright + Chromium ==="
      # ── Playwright + Chromium ───────────────────────────────────────
      # Install playwright system deps on build VM first
      sudo apt-get -y install --no-install-recommends \
        libasound2t64 libatk-bridge2.0-0t64 libatk1.0-0t64 libatspi2.0-0t64 \
        libcairo2 libcups2t64 libdbus-1-3 libdrm2 libgbm1 libglib2.0-0t64 \
        libnspr4 libnss3 libpango-1.0-0 libx11-6 libxcb1 \
        libxcomposite1 libxdamage1 libxext6 libxfixes3 libxkbcommon0 \
        libxrandr2 fonts-noto-color-emoji libfontconfig1 libfreetype6
      # Copy playwright system libs to layer
      for pkg in libasound2t64 libatk-bridge2.0-0t64 libatk1.0-0t64 libatspi2.0-0t64 \
          libcairo2 libcups2t64 libdbus-1-3 libdrm2 libgbm1 libglib2.0-0t64 \
          libnspr4 libnss3 libpango-1.0-0 libx11-6 libxcb1 \
          libxcomposite1 libxdamage1 libxext6 libxfixes3 libxkbcommon0 \
          libxrandr2 libfontconfig1 libfreetype6 fonts-noto-color-emoji; do
        dpkg -L "$pkg" 2>/dev/null | while read -r f; do
          [ -f "$f" ] || continue
          dir="$LAYER$(dirname "$f")"
          mkdir -p "$dir"
          cp "$f" "$LAYER${f}" 2>/dev/null || true
        done || true
      done
      # Copy shared libs for Playwright graphics stack
      for bin in /usr/lib/x86_64-linux-gnu/libcairo.so* /usr/lib/x86_64-linux-gnu/libpango*.so* \
          /usr/lib/x86_64-linux-gnu/libgdk*.so* /usr/lib/x86_64-linux-gnu/libgtk*.so*; do
        [ -f "$bin" ] || continue
        ldd "$bin" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read -r lib; do
          [ -f "$lib" ] || continue
          dir="$LAYER$(dirname "$lib")"
          mkdir -p "$dir"
          cp -n "$lib" "$LAYER${lib}" 2>/dev/null || true
        done || true
      done
      # Install Playwright + browser to layer
      PLAYWRIGHT_VERSION=1.50.1
      PATH="$LAYER/usr/local/bin:$PATH" npm install -g --prefix $LAYER/usr/local playwright@${PLAYWRIGHT_VERSION}
      PATH="$LAYER/usr/local/bin:$PATH" PLAYWRIGHT_BROWSERS_PATH=$LAYER/ms-playwright npx playwright install chromium
      chmod -R 777 $LAYER/ms-playwright

      echo "=== Installing project binaries + metadata ==="
      # ── Project binaries (gb, coop, kd) ─────────────────────────────
      cp ${{ tasks.build-gb.artifacts.gb-binary }} $LAYER/usr/local/bin/gb
      cp ${{ tasks.download-coop.artifacts.coop-binaries }}/coop $LAYER/usr/local/bin/coop
      cp ${{ tasks.download-kd.artifacts.kd-binaries }}/kd $LAYER/usr/local/bin/kd
      chmod +x $LAYER/usr/local/bin/gb $LAYER/usr/local/bin/coop $LAYER/usr/local/bin/kd

      # ── Hook scripts, scenarios, entrypoint ─────────────────────────
      mkdir -p $LAYER/hooks $LAYER/scenarios
      cp images/agent/hooks/*.sh $LAYER/hooks/
      chmod +x $LAYER/hooks/*.sh
      cp images/agent/scenarios/*.toml $LAYER/scenarios/
      cp images/agent/entrypoint.sh $LAYER/entrypoint.sh
      chmod +x $LAYER/entrypoint.sh

      # ── CA certs + version metadata ─────────────────────────────────
      mkdir -p $LAYER/etc/ssl/certs
      cp /etc/ssl/certs/ca-certificates.crt $LAYER/etc/ssl/certs/
      echo "${TAG}" > $LAYER/etc/gasboat-version

      # ── Agent user (rename ubuntu→agent, UID 1000) ──────────────────
      cp /etc/passwd $LAYER/etc/passwd
      sed -i "s/^ubuntu:/agent:/" $LAYER/etc/passwd
      sed -i "s|/home/ubuntu|/home/agent|" $LAYER/etc/passwd
      sed -i "s|/bin/sh|/bin/bash|" $LAYER/etc/passwd
      cp /etc/group $LAYER/etc/group
      sed -i "s/^ubuntu:/agent:/" $LAYER/etc/group
      mkdir -p $LAYER/home/agent/workspace

      # ── Fix ownership ───────────────────────────────────────────────
      sudo chown root:root $LAYER/usr/bin/sudo 2>/dev/null || true
      sudo chmod 4755 $LAYER/usr/bin/sudo 2>/dev/null || true
      sudo chown root:root $LAYER/etc/sudoers $LAYER/etc/sudoers.d 2>/dev/null || true
      sudo chown root:root $LAYER/etc/sudo.conf 2>/dev/null || true
      sudo chown -R 1000:1000 $LAYER/home/agent

      echo "=== Creating tar and pushing ==="
      # ── Create tar and push ─────────────────────────────────────────
      sudo tar -cf /tmp/layer.tar -C $LAYER .

      REPO="ghcr.io/groblegark/gasboat/agent"
      crane append --base ubuntu:24.04 --new_tag "${REPO}:${TAG}" --new_layer /tmp/layer.tar --platform linux/amd64
      crane mutate "${REPO}:${TAG}" \
        --entrypoint /entrypoint.sh \
        --user 1000 \
        --workdir /home/agent/workspace \
        -t "${REPO}:${TAG}"
      crane tag "${REPO}:${TAG}" latest
      echo "Pushed ${REPO}:${TAG} and ${REPO}:latest"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

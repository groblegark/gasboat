# OCI image builds for gasboat services — crane-based push to GHCR.
#
# Architecture:
#   build-* tasks     -> compile binaries as artifacts (cached by filters)
#   download-* tasks  -> fetch external deps as cached artifacts
#   push-*  tasks     -> crane-append layers to ubuntu:24.04, push to GHCR
#
# Images produced:
#   push-controller    -> ghcr.io/groblegark/gasboat/controller
#   push-agent         -> ghcr.io/groblegark/gasboat/agent
#   push-slack-bridge  -> ghcr.io/groblegark/gasboat/slack-bridge
#   push-jira-bridge   -> ghcr.io/groblegark/gasboat/jira-bridge
#
# For manual push of a single image:
#   rwx run .rwx/docker.yml --init commit-sha=$(git rev-parse HEAD) --target push-agent
#
# OPTIMIZATIONS:
# - Filter directives on Go mod downloads (cached by go.mod/go.sum)
# - Parallel builds with filter caching for dependency stability
# - Agent image split into 6 parallel cached install tasks + 1 assembly task
#   Cached by .rwx/agent-versions.lock — change versions there to bust cache

on:
  github:
    push:
      if: ${{ event.git.branch == 'main' || starts-with(event.git.tag, '20') }}
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.git.ref }}
        coop-version: latest
        kd-version: latest
      status-checks:
        name: Docker
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: pr
        coop-version: latest
        kd-version: latest
      status-checks:
        - tasks: [build-controller, build-gb, build-slack-bridge, build-jira-bridge, download-coop, download-kd]
          name: Docker
  dispatch:
    - key: gasboat-agent-rebuild
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.dispatch.params.trigger-source }}
        coop-version: ${{ event.dispatch.params.coop-version }}
        kd-version: ${{ event.dispatch.params.kd-version }}
      params:
        - key: trigger-source
          name: Trigger source
          description: What triggered the rebuild (e.g. coop-release, beads-release)
          default: manual
          required: false
        - key: coop-version
          name: Coop version
          description: Coop release tag to pin (e.g. 2026.056.0). Defaults to latest.
          default: latest
          required: false
        - key: kd-version
          name: Beads/kd version
          description: Beads release tag to pin (e.g. 2026.056.0). Defaults to latest.
          default: latest
          required: false
      title: Agent rebuild (${{ init.ref-name }})
      target: push-agent
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      ref-name: cli
      coop-version: latest
      kd-version: latest

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  # ═══════════════════════════════════════════════════════════════════════
  # Build tasks — compile and download in parallel, output binary artifacts
  # ═══════════════════════════════════════════════════════════════════════

  # ── Clone gasboat repo ─────────────────────────────────────────────
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/gasboat.git
      ref: ${{ init.commit-sha }}

  # ── Go toolchain ───────────────────────────────────────────────────
  - key: go
    call: golang/install 1.2.0
    with:
      go-version: "1.25"

  # ── Controller Go mod download (cached by go.mod/go.sum) ──────────
  - key: go-deps
    use: [code, go]
    run: cd controller && go mod download
    filter:
      - controller/go.mod
      - controller/go.sum

  # ── Build controller binary → artifact ─────────────────────────────
  - key: build-controller
    use: go-deps
    run: |
      cd controller
      REF_NAME="${REF_NAME#refs/tags/}"
      REF_NAME="${REF_NAME#refs/heads/}"
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w -X main.version=${REF_NAME} -X main.commit=${COMMIT_SHA}" \
        -o ../controller-bin ./cmd/controller/
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    outputs:
      artifacts:
        - key: controller-binary
          path: controller-bin

  # ── Build gb CLI binary → artifact ─────────────────────────────────
  - key: build-gb
    use: go-deps
    run: |
      cd controller
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w" \
        -o ../gb ./cmd/gb/
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    outputs:
      artifacts:
        - key: gb-binary
          path: gb

  # ── Build slack-bridge binary → artifact ───────────────────────────
  - key: build-slack-bridge
    use: go-deps
    run: |
      cd controller
      REF_NAME="${REF_NAME#refs/tags/}"
      REF_NAME="${REF_NAME#refs/heads/}"
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w -X main.version=${REF_NAME} -X main.commit=${COMMIT_SHA}" \
        -o ../slack-bridge ./cmd/slack-bridge/
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    outputs:
      artifacts:
        - key: slack-bridge-binary
          path: slack-bridge

  # ── Build jira-bridge binary → artifact ────────────────────────────
  - key: build-jira-bridge
    use: go-deps
    run: |
      cd controller
      REF_NAME="${REF_NAME#refs/tags/}"
      REF_NAME="${REF_NAME#refs/heads/}"
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w -X main.version=${REF_NAME} -X main.commit=${COMMIT_SHA}" \
        -o ../jira-bridge ./cmd/jira-bridge/
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    outputs:
      artifacts:
        - key: jira-bridge-binary
          path: jira-bridge

  # ── Download coop from releases → artifact (parallel, cached) ──────
  - key: download-coop
    run: |
      set -ex
      COOP_VER="${COOP_VERSION:-latest}"
      if [ "$COOP_VER" = "latest" ] || [ -z "$COOP_VER" ]; then
        COOP_VER=$(curl -fsSL https://api.github.com/repos/groblegark/coop/releases/latest | jq -r .tag_name)
      fi
      echo "Downloading coop ${COOP_VER} for linux-amd64"
      curl -fsSL "https://github.com/groblegark/coop/releases/download/${COOP_VER}/coop-linux-amd64.tar.gz" \
        -o /tmp/coop.tar.gz
      mkdir -p coop-bin
      tar -xzf /tmp/coop.tar.gz -C coop-bin
      ls -la coop-bin/
    env:
      COOP_VERSION: ${{ init.coop-version }}
    filter:
      - .rwx/cache-config.lock
    outputs:
      artifacts:
        - key: coop-binaries
          path: coop-bin

  # ── Download kd from releases → artifact (parallel, cached) ────────
  - key: download-kd
    run: |
      set -ex
      KD_VER="${KD_VERSION:-latest}"
      if [ "$KD_VER" = "latest" ] || [ -z "$KD_VER" ]; then
        KD_VER=$(curl -fsSL https://api.github.com/repos/groblegark/kbeads/releases/latest | jq -r .tag_name)
      fi
      VERSION_NUM=${KD_VER#v}
      echo "Downloading kd ${KD_VER} for linux_amd64"
      curl -fsSL "https://github.com/groblegark/kbeads/releases/download/${KD_VER}/kd-linux-x86_64.tar.gz" \
        -o /tmp/kd.tar.gz
      mkdir -p kd-bin
      tar -xzf /tmp/kd.tar.gz -C kd-bin
      ls -la kd-bin/
    env:
      KD_VERSION: ${{ init.kd-version }}
    filter:
      - .rwx/cache-config.lock
    outputs:
      artifacts:
        - key: kd-binaries
          path: kd-bin

  # ═══════════════════════════════════════════════════════════════════════
  # Push tasks — crane-append layers to ubuntu:24.04, push to GHCR.
  # Each push task builds a minimal OCI layer and pushes directly.
  # ═══════════════════════════════════════════════════════════════════════

  # ── Push controller (minimal static binary) ──────────────────────────
  - key: push-controller
    use: [build-controller]
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    run: |
      set -ex
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      # Install crane
      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/

      # Login to GHCR
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      # Build layer: static binary + CA certs
      mkdir -p /tmp/layer/etc/ssl/certs
      cp ${{ tasks.build-controller.artifacts.controller-binary }} /tmp/layer/controller
      chmod 755 /tmp/layer/controller
      cp /etc/ssl/certs/ca-certificates.crt /tmp/layer/etc/ssl/certs/
      tar -cf /tmp/layer.tar -C /tmp/layer .

      # Push
      REPO="ghcr.io/groblegark/gasboat/controller"
      crane append --base ubuntu:24.04 --new_tag "${REPO}:${TAG}" --new_layer /tmp/layer.tar --platform linux/amd64
      crane mutate "${REPO}:${TAG}" --entrypoint /controller --user nobody -t "${REPO}:${TAG}"
      crane tag "${REPO}:${TAG}" latest
      echo "Pushed ${REPO}:${TAG} and ${REPO}:latest"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── Push slack-bridge (minimal static binary) ────────────────────────
  - key: push-slack-bridge
    use: [build-slack-bridge]
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    run: |
      set -ex
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      mkdir -p /tmp/layer/etc/ssl/certs
      cp ${{ tasks.build-slack-bridge.artifacts.slack-bridge-binary }} /tmp/layer/slack-bridge
      chmod 755 /tmp/layer/slack-bridge
      cp /etc/ssl/certs/ca-certificates.crt /tmp/layer/etc/ssl/certs/
      tar -cf /tmp/layer.tar -C /tmp/layer .

      REPO="ghcr.io/groblegark/gasboat/slack-bridge"
      crane append --base ubuntu:24.04 --new_tag "${REPO}:${TAG}" --new_layer /tmp/layer.tar --platform linux/amd64
      crane mutate "${REPO}:${TAG}" --entrypoint /slack-bridge --user nobody -t "${REPO}:${TAG}"
      crane tag "${REPO}:${TAG}" latest
      echo "Pushed ${REPO}:${TAG} and ${REPO}:latest"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── Push jira-bridge (minimal static binary) ─────────────────────────
  - key: push-jira-bridge
    use: [build-jira-bridge]
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    run: |
      set -ex
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      mkdir -p /tmp/layer/etc/ssl/certs
      cp ${{ tasks.build-jira-bridge.artifacts.jira-bridge-binary }} /tmp/layer/jira-bridge
      chmod 755 /tmp/layer/jira-bridge
      cp /etc/ssl/certs/ca-certificates.crt /tmp/layer/etc/ssl/certs/
      tar -cf /tmp/layer.tar -C /tmp/layer .

      REPO="ghcr.io/groblegark/gasboat/jira-bridge"
      crane append --base ubuntu:24.04 --new_tag "${REPO}:${TAG}" --new_layer /tmp/layer.tar --platform linux/amd64
      crane mutate "${REPO}:${TAG}" --entrypoint /jira-bridge --user nobody -t "${REPO}:${TAG}"
      crane tag "${REPO}:${TAG}" latest
      echo "Pushed ${REPO}:${TAG} and ${REPO}:latest"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ═══════════════════════════════════════════════════════════════════════
  # Agent image — 6 parallel cached install tasks + 1 assembly task.
  # All install tasks filter on .rwx/agent-versions.lock so they're
  # cache hits when tool versions haven't changed. ~15min → ~2min.
  # ═══════════════════════════════════════════════════════════════════════

  # ── System packages: apt-get + dpkg copy + shared libs ──────────────
  - key: agent-install-syspackages
    timeout: 10m
    filter:
      - .rwx/agent-versions.lock
    run: |
      set -e
      export DEBIAN_FRONTEND=noninteractive
      OUT=/tmp/syspackages
      mkdir -p $OUT/usr/local/bin $OUT/usr/bin $OUT/etc

      sudo apt-get -y update
      sudo apt-get -y install --no-install-recommends \
        curl git git-lfs jq xz-utils ca-certificates screen \
        openssh-client sudo \
        python3 python3-pip python3-venv \
        make unzip \
        gcc g++ libc6-dev binutils \
        pkg-config libssl-dev \
        libcurl3t64-gnutls libicu74 libicu-dev \
        postgresql-client shellcheck

      for pkg in git git-man git-lfs curl jq screen ca-certificates xz-utils \
          openssh-client sudo libapparmor1 \
          python3 python3-minimal python3.12 python3.12-minimal \
          python3-pip python3-venv python3.12-venv \
          libpython3.12-stdlib libpython3.12-minimal \
          make gcc g++ unzip binutils shellcheck \
          gcc-14 g++-14 cpp-14 libgcc-14-dev \
          libc6-dev linux-libc-dev binutils-x86-64-linux-gnu \
          pkg-config libssl-dev \
          libcurl4t64 libcurl3t64-gnutls \
          libnghttp2-14 libbrotli1 libpsl5t64 libonig5 libexpat1 \
          libicu74 libicu-dev icu-devtools \
          postgresql-client libpq5; do
        dpkg -L "$pkg" 2>/dev/null | while read -r f; do
          [ -f "$f" ] || continue
          mkdir -p "$OUT$(dirname "$f")"
          cp "$f" "$OUT${f}" 2>/dev/null || true
        done || true
      done

      for bin in /usr/bin/git /usr/bin/curl /usr/bin/jq /usr/bin/screen \
          /usr/bin/python3 /usr/bin/ssh /usr/bin/make /usr/bin/gcc \
          /usr/bin/sudo /usr/bin/psql; do
        [ -f "$bin" ] || continue
        ldd "$bin" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read -r lib; do
          [ -f "$lib" ] || continue
          mkdir -p "$OUT$(dirname "$lib")"
          cp -n "$lib" "$OUT${lib}" 2>/dev/null || true
        done || true
      done

      # gcc internals
      find /usr/libexec/gcc -name 'cc1*' -o -name 'lto1' 2>/dev/null | while read -r bin; do
        ldd "$bin" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read -r lib; do
          [ -f "$lib" ] || continue
          mkdir -p "$OUT$(dirname "$lib")"
          cp -n "$lib" "$OUT${lib}" 2>/dev/null || true
        done || true
      done || true

      # ICU, headers, misc libs
      find /usr/lib/x86_64-linux-gnu -name 'libicu*.so*' 2>/dev/null | while read -r f; do
        mkdir -p "$OUT$(dirname "$f")" && cp -a "$f" "$OUT${f}" 2>/dev/null || true
      done || true
      [ -d /usr/include/unicode ] && mkdir -p $OUT/usr/include/unicode && cp -a /usr/include/unicode/* $OUT/usr/include/unicode/ 2>/dev/null || true
      for d in /usr/include/c++/14 /usr/include/c++/13; do
        if [ -d "$d" ]; then
          mkdir -p "$OUT$d" && cp -a "$d"/* "$OUT$d/" 2>/dev/null || true
          td="/usr/include/x86_64-linux-gnu/c++/$(basename $d)"
          [ -d "$td" ] && mkdir -p "$OUT$td" && cp -a "$td"/* "$OUT$td/" 2>/dev/null || true
          break
        fi
      done
      find /usr/lib/x86_64-linux-gnu/pkgconfig -name 'icu*.pc' 2>/dev/null | while read -r f; do
        mkdir -p "$OUT$(dirname "$f")" && cp "$f" "$OUT${f}" 2>/dev/null || true
      done || true
      cp -r /usr/lib/git-core $OUT/usr/lib/ 2>/dev/null || true
      [ -d /usr/libexec/gcc ] && mkdir -p $OUT/usr/libexec && cp -r /usr/libexec/gcc $OUT/usr/libexec/ 2>/dev/null || true
      for bin in /usr/bin/x86_64-linux-gnu-as /usr/bin/x86_64-linux-gnu-ld /usr/bin/as /usr/bin/ld; do
        [ -f "$bin" ] || continue
        ldd "$bin" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read -r lib; do
          [ -f "$lib" ] || continue
          mkdir -p "$OUT$(dirname "$lib")" && cp -n "$lib" "$OUT${lib}" 2>/dev/null || true
        done || true
      done
      for script in /usr/lib/x86_64-linux-gnu/libc.so /usr/lib/x86_64-linux-gnu/libm.so; do
        [ -f "$script" ] || continue
        grep -oP '/lib/x86_64-linux-gnu/\S+' "$script" 2>/dev/null | tr -d ')' | while read -r ref; do
          [ -f "$OUT$ref" ] && continue
          src="/usr${ref}"; [ -f "$src" ] || src="$ref"; [ -f "$src" ] || continue
          mkdir -p "$OUT$(dirname "$ref")" && cp "$src" "$OUT$ref" 2>/dev/null || true
        done || true
      done
      for d in /usr/lib/gcc/x86_64-linux-gnu/14 /usr/lib/gcc/x86_64-linux-gnu/13; do
        [ -d "$d" ] && mkdir -p "$OUT$d" && cp -a "$d"/* "$OUT$d/" 2>/dev/null && break || true
      done
      find /usr/lib/x86_64-linux-gnu -name 'libcurl-gnutls*' 2>/dev/null | while read -r f; do
        mkdir -p "$OUT$(dirname "$f")" && cp -a "$f" "$OUT${f}" 2>/dev/null || true
      done || true
      mkdir -p $OUT/usr/libexec/sudo && cp /usr/libexec/sudo/*.so* $OUT/usr/libexec/sudo/ 2>/dev/null || true
      ln -sf python3 $OUT/usr/bin/python

      sudo tar -cf syspackages.tar -C $OUT .
    outputs:
      artifacts:
        - key: syspackages-tar
          path: syspackages.tar

  # ── Node.js + Claude Code + Playwright + Chromium ───────────────────
  - key: agent-install-node
    timeout: 10m
    filter:
      - .rwx/agent-versions.lock
    run: |
      set -e
      export DEBIAN_FRONTEND=noninteractive
      OUT=/tmp/node-layer
      mkdir -p $OUT/usr/local

      # Node.js
      NODE_FULL=$(curl -fsSL "https://nodejs.org/dist/index.json" \
        | jq -r '[.[] | select(.version | startswith("v24."))][0].version')
      [ "${NODE_FULL}" != "null" ] && [ -n "${NODE_FULL}" ] && \
      curl -fsSL "https://nodejs.org/dist/${NODE_FULL}/node-${NODE_FULL}-linux-x64.tar.xz" \
        | tar -xJ --strip-components=1 -C $OUT/usr/local

      # Claude Code
      PATH="$OUT/usr/local/bin:$PATH" npm install -g --prefix $OUT/usr/local @anthropic-ai/claude-code

      # Playwright + Chromium
      PLAYWRIGHT_VERSION=1.50.1
      PATH="$OUT/usr/local/bin:$PATH" npm install -g --prefix $OUT/usr/local playwright@${PLAYWRIGHT_VERSION}

      # Playwright system deps
      sudo apt-get -y update
      sudo apt-get -y install --no-install-recommends \
        libasound2t64 libatk-bridge2.0-0t64 libatk1.0-0t64 libatspi2.0-0t64 \
        libcairo2 libcups2t64 libdbus-1-3 libdrm2 libgbm1 libglib2.0-0t64 \
        libnspr4 libnss3 libpango-1.0-0 libx11-6 libxcb1 \
        libxcomposite1 libxdamage1 libxext6 libxfixes3 libxkbcommon0 \
        libxrandr2 fonts-noto-color-emoji libfontconfig1 libfreetype6
      for pkg in libasound2t64 libatk-bridge2.0-0t64 libatk1.0-0t64 libatspi2.0-0t64 \
          libcairo2 libcups2t64 libdbus-1-3 libdrm2 libgbm1 libglib2.0-0t64 \
          libnspr4 libnss3 libpango-1.0-0 libx11-6 libxcb1 \
          libxcomposite1 libxdamage1 libxext6 libxfixes3 libxkbcommon0 \
          libxrandr2 libfontconfig1 libfreetype6 fonts-noto-color-emoji; do
        dpkg -L "$pkg" 2>/dev/null | while read -r f; do
          [ -f "$f" ] || continue
          mkdir -p "$OUT$(dirname "$f")" && cp "$f" "$OUT${f}" 2>/dev/null || true
        done || true
      done
      for bin in /usr/lib/x86_64-linux-gnu/libcairo.so* /usr/lib/x86_64-linux-gnu/libpango*.so* \
          /usr/lib/x86_64-linux-gnu/libgdk*.so* /usr/lib/x86_64-linux-gnu/libgtk*.so*; do
        [ -f "$bin" ] || continue
        ldd "$bin" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read -r lib; do
          [ -f "$lib" ] || continue
          mkdir -p "$OUT$(dirname "$lib")" && cp -n "$lib" "$OUT${lib}" 2>/dev/null || true
        done || true
      done
      PATH="$OUT/usr/local/bin:$PATH" PLAYWRIGHT_BROWSERS_PATH=$OUT/ms-playwright npx playwright install chromium
      chmod -R 777 $OUT/ms-playwright

      tar -cf node-layer.tar -C $OUT .
    outputs:
      artifacts:
        - key: node-tar
          path: node-layer.tar

  # ── Go + gopls + golangci-lint + Task CLI ───────────────────────────
  - key: agent-install-go
    timeout: 10m
    filter:
      - .rwx/agent-versions.lock
    run: |
      set -e
      OUT=/tmp/go-layer
      mkdir -p $OUT/usr/local/bin

      GO_LATEST=$(curl -fsSL "https://go.dev/dl/?mode=json" \
        | jq -r '[.[] | select(.version | startswith("go1.25"))][0].version')
      curl -fsSL "https://go.dev/dl/${GO_LATEST}.linux-amd64.tar.gz" | tar -C $OUT/usr/local -xz

      GOROOT=$OUT/usr/local/go GOPATH=/tmp/gopath $OUT/usr/local/go/bin/go install golang.org/x/tools/gopls@latest 2>/dev/null || true
      cp /tmp/gopath/bin/gopls $OUT/usr/local/go/bin/ 2>/dev/null || true

      GOROOT=$OUT/usr/local/go GOPATH=/tmp/gopath $OUT/usr/local/go/bin/go install github.com/go-task/task/v3/cmd/task@latest
      mv /tmp/gopath/bin/task $OUT/usr/local/bin/task
      chmod -R u+w /tmp/gopath 2>/dev/null || true
      rm -rf /tmp/gopath

      ln -sf /usr/local/go/bin/go $OUT/usr/local/bin/go
      ln -sf /usr/local/go/bin/gofmt $OUT/usr/local/bin/gofmt
      ln -sf /usr/local/go/bin/gopls $OUT/usr/local/bin/gopls

      curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh \
        | sh -s -- -b $OUT/usr/local/bin "v1.64.8"

      tar -cf go-layer.tar -C $OUT .
    outputs:
      artifacts:
        - key: go-tar
          path: go-layer.tar

  # ── Rust + rust-analyzer + quench ───────────────────────────────────
  - key: agent-install-rust
    timeout: 15m
    filter:
      - .rwx/agent-versions.lock
    run: |
      set -e
      OUT=/tmp/rust-layer
      mkdir -p $OUT/usr/local/bin

      export RUSTUP_HOME=$OUT/usr/local/rustup CARGO_HOME=$OUT/usr/local/cargo
      curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs \
        | sh -s -- -y --default-toolchain stable --profile default \
            --component rust-analyzer
      chmod -R a+rw $OUT/usr/local/rustup $OUT/usr/local/cargo

      curl -fsSL "https://github.com/rust-lang/rust-analyzer/releases/latest/download/rust-analyzer-x86_64-unknown-linux-gnu.gz" \
        | gunzip > $OUT/usr/local/bin/rust-analyzer
      chmod +x $OUT/usr/local/bin/rust-analyzer

      # quench needs gcc — install it temporarily
      sudo apt-get -y update && sudo apt-get -y install --no-install-recommends gcc libc6-dev pkg-config libssl-dev
      PATH="$OUT/usr/local/cargo/bin:$PATH" cargo install quench \
        --git https://github.com/alfredjeanlab/quench --root /tmp/quench-out
      cp /tmp/quench-out/bin/quench $OUT/usr/local/bin/quench
      rm -rf /tmp/quench-out

      tar -cf rust-layer.tar -C $OUT .
    outputs:
      artifacts:
        - key: rust-tar
          path: rust-layer.tar

  # ── CLI tools (all small binary downloads) ──────────────────────────
  - key: agent-install-clis
    timeout: 10m
    filter:
      - .rwx/agent-versions.lock
    run: |
      set -e
      OUT=/tmp/cli-layer
      mkdir -p $OUT/usr/local/bin $OUT/opt

      # kubectl
      KUBECTL_VERSION=$(curl -fsSL https://dl.k8s.io/release/stable.txt)
      curl -fsSL "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl" -o $OUT/usr/local/bin/kubectl
      chmod +x $OUT/usr/local/bin/kubectl

      # GitHub CLI
      GH_VERSION=$(curl -fsSL "https://api.github.com/repos/cli/cli/releases/latest" | jq -r .tag_name | sed "s/^v//")
      curl -fsSL "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz" \
        | tar -xz --strip-components=2 -C $OUT/usr/local/bin "gh_${GH_VERSION}_linux_amd64/bin/gh"

      # GitLab CLI
      GLAB_VERSION=$(curl -fsSL "https://gitlab.com/api/v4/projects/gitlab-org%2Fcli/releases" | jq -r '.[0].tag_name | ltrimstr("v")')
      curl -fsSL "https://gitlab.com/gitlab-org/cli/-/releases/v${GLAB_VERSION}/downloads/glab_${GLAB_VERSION}_linux_amd64.tar.gz" \
        | tar -xz --strip-components=1 -C $OUT/usr/local/bin bin/glab

      # Docker CLI
      curl -fsSL "https://download.docker.com/linux/static/stable/x86_64/docker-27.5.1.tgz" \
        | tar -xz --strip-components=1 -C $OUT/usr/local/bin docker/docker

      # AWS CLI
      curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscli.zip
      unzip -q /tmp/awscli.zip -d /tmp
      /tmp/aws/install --install-dir /tmp/aws-install --bin-dir /tmp/aws-bin
      mkdir -p $OUT/opt/aws-cli
      cp -r /tmp/aws-install/* $OUT/opt/aws-cli/
      rm -rf $OUT/opt/aws-cli/v2/current
      AWS_VER=$(ls $OUT/opt/aws-cli/v2/ | head -1)
      ln -sf "$AWS_VER" $OUT/opt/aws-cli/v2/current
      rm -rf $OUT/opt/aws-cli/bin
      mkdir -p $OUT/opt/aws-cli/bin
      ln -sf /opt/aws-cli/v2/current/bin/aws $OUT/opt/aws-cli/bin/aws
      ln -sf /opt/aws-cli/v2/current/bin/aws_completer $OUT/opt/aws-cli/bin/aws_completer
      ln -sf /opt/aws-cli/v2/current/bin/aws $OUT/usr/local/bin/aws

      # RWX CLI
      curl -fsSL "https://github.com/rwx-cloud/cli/releases/latest/download/rwx-linux-x86_64" -o $OUT/usr/local/bin/rwx
      chmod +x $OUT/usr/local/bin/rwx

      # Claudeless
      curl -fsSL "https://github.com/alfredjeanlab/claudeless/releases/download/v0.4.0/claudeless-linux-x86_64.tar.gz" \
        | tar -xz -C $OUT/usr/local/bin claudeless
      chmod +x $OUT/usr/local/bin/claudeless

      # uv
      curl -LsSf https://astral.sh/uv/install.sh | env INSTALLER_NO_MODIFY_PATH=1 sh
      mv ~/.local/bin/uv $OUT/usr/local/bin/uv
      mv ~/.local/bin/uvx $OUT/usr/local/bin/uvx

      # Bun
      BUN_INSTALL=$OUT/usr/local/bun curl -fsSL https://bun.sh/install | bash
      ln -sf /usr/local/bun/bin/bun $OUT/usr/local/bin/bun
      ln -sf /usr/local/bun/bin/bunx $OUT/usr/local/bin/bunx

      # Helm + plugins
      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | sudo bash
      cp /usr/local/bin/helm $OUT/usr/local/bin/helm
      mkdir -p $OUT/usr/local/share
      HELM_DATA_HOME=$OUT/usr/local/share/helm helm plugin install https://github.com/helm-unittest/helm-unittest
      HELM_DATA_HOME=$OUT/usr/local/share/helm helm plugin install https://github.com/chartmuseum/helm-push

      # Terraform + Terragrunt
      curl -fsSL "https://releases.hashicorp.com/terraform/1.11.3/terraform_1.11.3_linux_amd64.zip" -o /tmp/terraform.zip
      unzip -q /tmp/terraform.zip -d $OUT/usr/local/bin && rm /tmp/terraform.zip
      curl -fsSL "https://github.com/gruntwork-io/terragrunt/releases/download/v0.77.11/terragrunt_linux_amd64" -o $OUT/usr/local/bin/terragrunt
      chmod +x $OUT/usr/local/bin/terragrunt

      # yq
      YQ_VERSION=$(curl -fsSL "https://api.github.com/repos/mikefarah/yq/releases/latest" | jq -r .tag_name)
      curl -fsSL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" -o $OUT/usr/local/bin/yq
      chmod +x $OUT/usr/local/bin/yq

      # stern
      curl -fsSL "https://github.com/stern/stern/releases/download/v1.30.0/stern_1.30.0_linux_amd64.tar.gz" \
        | tar -xz -C $OUT/usr/local/bin stern

      # hadolint
      curl -fsSL "https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64" -o $OUT/usr/local/bin/hadolint
      chmod +x $OUT/usr/local/bin/hadolint

      tar -cf cli-layer.tar -C $OUT .
    outputs:
      artifacts:
        - key: clis-tar
          path: cli-layer.tar

  # ── Assembly: merge all layers + project binaries → push ────────────
  - key: push-agent
    use: [code, build-gb, download-coop, download-kd, agent-install-syspackages, agent-install-node, agent-install-go, agent-install-rust, agent-install-clis]
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    timeout: 10m
    run: |
      set -e
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      # Install crane
      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      LAYER=/tmp/layer
      mkdir -p $LAYER

      # Unpack all cached install layers
      echo "=== Unpacking cached layers ==="
      sudo tar -xf ${{ tasks.agent-install-syspackages.artifacts.syspackages-tar }} -C $LAYER
      tar -xf ${{ tasks.agent-install-node.artifacts.node-tar }} -C $LAYER
      tar -xf ${{ tasks.agent-install-go.artifacts.go-tar }} -C $LAYER
      tar -xf ${{ tasks.agent-install-rust.artifacts.rust-tar }} -C $LAYER
      tar -xf ${{ tasks.agent-install-clis.artifacts.clis-tar }} -C $LAYER

      # Project binaries (gb, coop, kd)
      echo "=== Adding project binaries ==="
      cp ${{ tasks.build-gb.artifacts.gb-binary }} $LAYER/usr/local/bin/gb
      cp ${{ tasks.download-coop.artifacts.coop-binaries }}/coop $LAYER/usr/local/bin/coop
      cp ${{ tasks.download-kd.artifacts.kd-binaries }}/kd $LAYER/usr/local/bin/kd
      chmod +x $LAYER/usr/local/bin/gb $LAYER/usr/local/bin/coop $LAYER/usr/local/bin/kd

      # Hook scripts, scenarios, entrypoint
      mkdir -p $LAYER/hooks $LAYER/scenarios
      cp images/agent/hooks/*.sh $LAYER/hooks/
      chmod +x $LAYER/hooks/*.sh
      cp images/agent/scenarios/*.toml $LAYER/scenarios/
      cp images/agent/entrypoint.sh $LAYER/entrypoint.sh
      chmod +x $LAYER/entrypoint.sh

      # CA certs + version metadata
      mkdir -p $LAYER/etc/ssl/certs
      cp /etc/ssl/certs/ca-certificates.crt $LAYER/etc/ssl/certs/
      echo "${TAG}" > $LAYER/etc/gasboat-version

      # Sudoers config
      sudo mkdir -p $LAYER/etc/sudoers.d
      printf 'Defaults   env_reset\nDefaults   secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/go/bin"\nroot ALL=(ALL:ALL) ALL\n#includedir /etc/sudoers.d\n' | sudo tee $LAYER/etc/sudoers > /dev/null
      sudo chmod 0440 $LAYER/etc/sudoers
      printf 'agent ALL=(ALL) NOPASSWD: ALL\n' | sudo tee $LAYER/etc/sudoers.d/agent > /dev/null
      sudo chmod 0440 $LAYER/etc/sudoers.d/agent
      sudo cp /etc/sudo.conf $LAYER/etc/sudo.conf 2>/dev/null || true

      # Agent user (rename ubuntu→agent, UID 1000)
      cp /etc/passwd $LAYER/etc/passwd
      sed -i "s/^ubuntu:/agent:/" $LAYER/etc/passwd
      sed -i "s|/home/ubuntu|/home/agent|" $LAYER/etc/passwd
      sed -i "s|/bin/sh|/bin/bash|" $LAYER/etc/passwd
      cp /etc/group $LAYER/etc/group
      sed -i "s/^ubuntu:/agent:/" $LAYER/etc/group
      mkdir -p $LAYER/home/agent/workspace

      # Fix ownership
      sudo chown root:root $LAYER/usr/bin/sudo 2>/dev/null || true
      sudo chmod 4755 $LAYER/usr/bin/sudo 2>/dev/null || true
      sudo chown root:root $LAYER/etc/sudoers $LAYER/etc/sudoers.d 2>/dev/null || true
      sudo chown root:root $LAYER/etc/sudo.conf 2>/dev/null || true
      sudo chown -R 1000:1000 $LAYER/home/agent

      # Create tar and push
      echo "=== Pushing image ==="
      sudo tar -cf /tmp/layer.tar -C $LAYER .

      REPO="ghcr.io/groblegark/gasboat/agent"
      crane append --base ubuntu:24.04 --new_tag "${REPO}:${TAG}" --new_layer /tmp/layer.tar --platform linux/amd64
      crane mutate "${REPO}:${TAG}" \
        --entrypoint /entrypoint.sh \
        --user 1000 \
        --workdir /home/agent/workspace \
        -t "${REPO}:${TAG}"
      crane tag "${REPO}:${TAG}" latest
      echo "Pushed ${REPO}:${TAG} and ${REPO}:latest"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ═══════════════════════════════════════════════════════════════════════
  # Re-tag external images at gasboat calver — one tag for everything.
  # Copies the current rolling tag so helm appVersion works for all images.
  # ═══════════════════════════════════════════════════════════════════════

  # ── Re-tag coopmux → gasboat calver ───────────────────────────────────
  - key: retag-coopmux
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    run: |
      set -ex
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      crane cp ghcr.io/groblegark/coop:coopmux ghcr.io/groblegark/coop:${TAG}
      echo "Re-tagged coop:coopmux → coop:${TAG}"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── Re-tag kbeads → gasboat calver ───────────────────────────────────
  - key: retag-kbeads
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    run: |
      set -ex
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      crane cp ghcr.io/groblegark/kbeads:latest ghcr.io/groblegark/kbeads:${TAG}
      echo "Re-tagged kbeads:latest → kbeads:${TAG}"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

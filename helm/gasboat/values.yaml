# Gasboat Helm Chart Configuration
# Components: Beads Daemon, Agent Controller, Coopmux, and optionally PostgreSQL and NATS.

imagePullSecrets: []

# =============================================================================
# Registry Pull Secrets (ExternalSecrets for private container registries)
# =============================================================================
registrySecrets:
  enabled: false
  secretStoreName: "secretstore"
  secretStoreKind: ClusterSecretStore
  refreshInterval: "1h"
  registries: {}
  # registries:
  #   ghcr-registry:
  #     enabled: true
  #     remoteRef: "shared-devops-ghcr.io-credentials"
  #     hosts: ["ghcr.io"]

# =============================================================================
# External Secrets (creates K8s Secrets from external secret stores)
# =============================================================================
externalSecrets:
  enabled: false
  secretStoreName: "secretstore"
  secretStoreKind: ClusterSecretStore
  refreshInterval: "1h"
  # PostgreSQL password
  postgresPassword:
    remoteRef: ""
    property: ""
  # Beads daemon auth token
  beadsToken:
    remoteRef: ""
    property: ""

# =============================================================================
# Agent Controller (manages agent pods for beads automation)
# =============================================================================
agents:
  enabled: false

  # --- Controller deployment ---

  image:
    repository: ghcr.io/groblegark/gasboat
    tag: ""
    pullPolicy: Always

  serviceAccount:
    create: true
    name: ""
    annotations: {}

  replicaCount: 1

  # Log level for the controller: debug, info, warn, error
  logLevel: ""

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  # --- Agent pods ---

  # Image used for agent pods spawned by the controller (includes gb + kd CLIs)
  agentImage:
    repository: ghcr.io/groblegark/gasboat/agent
    tag: ""

  # ServiceAccount for spawned agent pods (not the controller itself).
  # When create=true, the chart provisions a SA + namespace-admin Role + RoleBinding.
  # The SA name is passed to the agents controller via COOP_SERVICE_ACCOUNT env var.
  agentServiceAccount:
    create: true
    name: ""        # defaults to "<release>-agent"
    annotations: {}

  # Optional cluster-admin ServiceAccount for agent pods that need full cluster access.
  # Creates a separate SA + ClusterRoleBinding to the built-in cluster-admin ClusterRole.
  # Assign to specific projects via the project bead's service_account field.
  clusterAdmin:
    enabled: false
    name: ""          # defaults to "<release>-agent-cluster-admin"
    annotations: {}

  # Default StorageClass for agent workspace PVCs (e.g., "gp2").
  # If empty, uses cluster default. Project beads can override per-project.
  agentStorageClass: ""

  # Default Claude model for agent pods (e.g., "claude-opus-4-6").
  # If empty, Claude Code uses its built-in default (Sonnet).
  claudeModel: ""

  # Max agent pods that can exist simultaneously (0 = unlimited)
  coopMaxPods: 0

  # Max pods to create in a single reconciliation pass (prevents memory pressure)
  coopBurstLimit: 3

  # Periodic reconciliation interval (e.g. "60s", "5m")
  coopSyncInterval: ""

  # --- Secrets & credentials ---

  # K8s secret with Claude OAuth credentials for agent pods (Max/Corp accounts)
  # Mount as ~/.claude/.credentials.json. See scripts/sync-claude-credentials.sh
  claudeOAuthSecret: ""

  # K8s secret with Claude OAuth access token (key: "token").
  # Injected as CLAUDE_CODE_OAUTH_TOKEN env var. Coop auto-writes .credentials.json
  # when this is set — preferred over the static credentials secret mount.
  claudeOAuthTokenSecret: ""
  claudeOAuthTokenExternalSecret:
    enabled: false
    secretStoreName: "secretstore"
    secretStoreKind: ClusterSecretStore
    refreshInterval: "15m"
    remoteRef: ""
    tokenProperty: "token"

  # K8s secret with Anthropic API key (key: "key").
  # Injected as ANTHROPIC_API_KEY env var. Fallback when OAuth is unavailable.
  anthropicApiKeySecret: ""

  # Git credentials for agent pods (username/token keys).
  gitCredentials:
    secret: ""           # K8s secret name (created manually or by externalSecret below)
    externalSecret:      # Creates the K8s secret from a secret store
      enabled: false
      secretStoreName: "secretstore"
      secretStoreKind: ClusterSecretStore
      refreshInterval: "15m"
      remoteRef: ""
      usernameProperty: "username"
      tokenProperty: "token"

  # K8s secret with GitHub token for gh CLI in agent pods (releases, GHCR push)
  githubTokenSecret: ""

  # K8s secret with GitLab token for glab CLI and git clone/push in agent pods.
  # Set gitlabTokenSecret to the K8s secret name; the secret must contain a "token" key.
  # Use gitlabTokenExternalSecret to have the Helm chart create it from AWS Secrets Manager.
  gitlabTokenSecret: ""
  gitlabTokenExternalSecret:   # Creates the K8s secret from a secret store
    enabled: false
    secretStoreName: "secretstore"
    secretStoreKind: ClusterSecretStore
    refreshInterval: "15m"
    remoteRef: ""              # e.g. "gasboat/gitlab-token"
    tokenProperty: "token"    # JSON key inside the AWS secret

  # K8s secret with RWX access token for RWX API calls in agent pods (dispatches, triggers)
  rwxAccessTokenSecret: ""
  rwxAccessTokenExternalSecret:
    enabled: false
    secretStoreName: "secretstore"
    secretStoreKind: ClusterSecretStore
    refreshInterval: "15m"
    remoteRef: ""
    tokenProperty: "token"

  # --- NATS event bus ---

  # NATS server URL for event bus integration (e.g., "nats://nats-svc:4222")
  natsURL: ""

  # K8s secret with NATS auth token for agent pods
  natsTokenSecret: ""

  # --- Coopmux ---

  # Coopmux URL override (auto-wired when coopmux is enabled in this chart)
  coopmuxURL: ""

  # --- Infrastructure ---

  # Pod disruption budget for safe rolling deploys (only useful with replicaCount > 1)
  podDisruptionBudget:
    enabled: false
    minAvailable: 1

  # Pod scheduling
  nodeSelector: {}
  tolerations: []
  affinity: {}

# =============================================================================
# Coopmux — centralized credential manager + terminal multiplexer
# Manages credential refresh, distributes tokens, and multiplexes terminal
# views for all agent pods.
# =============================================================================
coopmux:
  enabled: false

  image:
    repository: ghcr.io/groblegark/coop
    tag: ""
    pullPolicy: Always

  replicaCount: 1

  # Auth token for coopmux API (agent pods use this to register/authenticate)
  # If empty, uses the daemon token secret
  coopmuxTokenSecret: ""

  # K8s secret containing the Claude API key for coopmux
  claudeApiKeySecret: ""
  # Key within the secret that holds the API key (default: ANTHROPIC_API_KEY)
  claudeApiKeyField: "ANTHROPIC_API_KEY"

  # NATS connection (must be explicitly set — no auto-wiring)
  natsURL: ""

  # Persistence: previously used for OAuth credentials.json, now
  # deprecated after switch to static API keys.
  persistence:
    enabled: false
    size: 100Mi
    storageClass: ""
    path: "/var/lib/coop/credentials/credentials.json"

  # OAuth credential configuration
  credentials:
    accountName: "claude-max"
    provider: "claude"
    clientId: "9d1c250a-e61b-44d9-88ed-5944d1962f5e"
    tokenUrl: "https://platform.claude.com/v1/oauth/token"
    deviceAuthUrl: "https://console.anthropic.com/v1/oauth/device/code"
    refreshMarginSecs: 300
    # Set to false to treat credentials as static (no OAuth refresh).
    reauth: true
  # Additional accounts (list of {name, provider, clientId, tokenUrl, deviceAuthUrl, refreshMarginSecs})
  extraAccounts: []

  # ExternalSecret for Claude API key (creates the claudeApiKeySecret from a secret store)
  apiKeyExternalSecret:
    enabled: false
    secretStoreName: "secretstore"
    secretStoreKind: ClusterSecretStore
    refreshInterval: "1h"
    remoteRef: ""
    property: "api-key"

  # ExternalSecret for OAuth refresh token
  externalSecret:
    enabled: false
    secretStoreName: "secretstore"
    secretStoreKind: ClusterSecretStore
    refreshInterval: "15m"
    remoteRef: ""
    refreshTokenProperty: "refresh_token"

  # Ingress (Traefik IngressRoute for coopmux dashboard)
  ingress:
    enabled: false
    host: ""
    # Expose full API at / (default: mux-only at /mux, /ws/mux, /api/v1/sessions)
    exposeAPI: false
    # Bearer token injected into requests so coopmux auth is satisfied.
    bearerToken: ""
    ipWhitelist:
      enabled: false
      sourceRange: []
      depth: 1
    basicAuth:
      enabled: false
      secret: ""
    rateLimit:
      enabled: false
      average: 100
      burst: 200

  # NATS relay for local agent discovery (requires coopmux binary with --nats-relay-url support)
  natsRelay:
    enabled: false
    url: ""       # defaults to natsURL when empty
    prefix: "coop.mux"

  # Coopmux settings
  mux:
    port: 9800
    screenPollMs: 500
    statusPollMs: 2000
    healthCheckMs: 10000
    maxHealthFailures: 3

  # Service
  service:
    type: ClusterIP
    port: 9800

  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  # Pod Disruption Budget (active when replicaCount > 1).
  pdb:
    enabled: false
    maxUnavailable: 1

  # Pod scheduling
  nodeSelector: {}
  tolerations: []
  affinity: {}

# =============================================================================
# PostgreSQL (in-chart database for beads)
# =============================================================================
postgres:
  enabled: false

  image:
    repository: postgres
    tag: "17-alpine"
    pullPolicy: IfNotPresent

  # Database name created on init
  database: beads

  # Password secret — created by externalSecrets or manually.
  # If empty, uses the auto-generated secret name from helpers.
  passwordSecret: ""

  persistence:
    enabled: true
    size: 10Gi
    storageClass: ""

  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: "1"
      memory: 1Gi

  # Pod scheduling
  nodeSelector: {}
  tolerations: []
  affinity: {}

# =============================================================================
# Beads Daemon (kd serve — gRPC + HTTP API backed by PostgreSQL)
# =============================================================================
beads:
  image:
    repository: ghcr.io/groblegark/kbeads
    tag: ""
    pullPolicy: Always

  replicaCount: 1

  # Explicit database URL override (bypasses auto-wiring from postgres.enabled)
  databaseURL: ""

  # Explicit NATS URL override (bypasses auto-wiring from nats.enabled)
  natsURL: ""

  # Name of K8s secret containing the daemon auth token (key: "token")
  tokenSecret: kd-beads-token

  ingress:
    enabled: false
    host: ""
    ipWhitelist:
      enabled: false
      sourceRange: []
      depth: 1
    rateLimit:
      enabled: false
      average: 100
      burst: 200

  service:
    type: ClusterIP
    grpcPort: 9090
    httpPort: 8080

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  # Pod scheduling
  nodeSelector: {}
  tolerations: []
  affinity: {}

# =============================================================================
# NATS (JetStream event bus for beads + agents + coopmux)
# =============================================================================
nats:
  enabled: false

  replicas: 1

  image:
    registry: docker.io
    repository: nats
    tag: "2.10-alpine"
    pullPolicy: IfNotPresent

  auth:
    enabled: false
    token: ""

  jetstream:
    maxMemory: "256M"

  persistence:
    enabled: true
    size: 2Gi
    storageClass: ""

  cluster:
    port: 6222

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  pdb:
    enabled: false
    maxUnavailable: 1

  # Pod scheduling
  affinity: {}
  nodeSelector: {}
  tolerations: []

# =============================================================================
# Slack Bridge — standalone beads→Slack notification bridge
# Watches NATS for decision/mail lifecycle events and notifies Slack.
# Runs independently from the agent controller (separate deployment).
# =============================================================================
slackBridge:
  enabled: false

  image:
    repository: ghcr.io/groblegark/gasboat/slack-bridge
    tag: ""
    pullPolicy: Always

  replicaCount: 1

  # Log level: debug, info, warn, error
  logLevel: ""

  # NATS URL override (auto-wired when nats.enabled=true)
  natsURL: ""

  # Slack credentials
  slack:
    # Direct values (for dev/testing)
    botToken: ""
    appToken: ""      # xapp-... token for Socket Mode (real-time events, interactions, modals)
    signingSecret: ""
    channel: ""
    # K8s secret name with keys: bot-token, app-token, signing-secret (for production)
    secretName: ""
    # Decision threading mode: "flat" (default) or "agent" (thread under per-agent cards)
    threadingMode: ""

  # Live agent activity dashboard — pinned Slack message updated periodically.
  dashboard:
    enabled: true
    channel: ""       # Dashboard channel (defaults to slack.channel if empty)
    interval: ""      # Poll interval (e.g., "15s", "30s"); default 15s

  service:
    type: ClusterIP
    port: 8090

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

  # State persistence — survives pod restarts, preserves Slack message refs.
  # When disabled (default), an emptyDir is used (state lost on restart).
  persistence:
    enabled: false
    size: 100Mi
    storageClass: ""

  # Pod scheduling
  nodeSelector: {}
  tolerations: []
  affinity: {}

# =============================================================================
# JIRA Bridge — standalone beads→JIRA sync bridge
# Polls JIRA for new tickets, creates task beads, and syncs MR links/status
# back to JIRA. Runs independently from the agent controller.
# =============================================================================
jiraBridge:
  enabled: false

  image:
    repository: ghcr.io/groblegark/gasboat/jira-bridge
    tag: ""
    pullPolicy: Always

  replicaCount: 1

  # Log level: debug, info, warn, error
  logLevel: ""

  # JIRA connection and polling config
  jira:
    # JIRA instance URL (required)
    baseURL: ""
    # JIRA user email for API auth (required)
    email: ""
    # Direct API token (for dev/testing)
    apiToken: ""
    # K8s secret name with key: api-token (for production)
    secretName: ""
    # Comma-separated project keys to poll (e.g., "PE,DEVOPS")
    projects: "PE,DEVOPS"
    # Comma-separated JIRA statuses to ingest
    statuses: "To Do,Ready for Development"
    # Comma-separated issue types to ingest
    issueTypes: "Bug,Task,Story"
    # Polling interval (e.g., "60s", "5m")
    pollInterval: "60s"
    # BOAT_PROJECTS mapping: comma-separated entries of the form
    # {project_name}={git_url}:{jira_prefix}
    # Maps JIRA project prefixes to boat project names so beads get the correct
    # project label (e.g., PE issues → project:monorepo instead of project:pe).
    # Example: "gasboat=https://github.com/org/gasboat.git:KD,monorepo=https://gitlab.com/org/repo:PE"
    boatProjects: ""
    # Disable JIRA issue transitions on bead close (default: transitions enabled)
    disableTransitions: false

  service:
    type: ClusterIP
    port: 8091

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

  # Pod scheduling
  nodeSelector: {}
  tolerations: []
  affinity: {}

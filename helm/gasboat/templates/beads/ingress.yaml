{{- if .Values.beads.ingress.enabled }}
{{- $fullname := include "gasboat.beads.fullname" . -}}
{{- $host := .Values.beads.ingress.host -}}
{{- $httpPort := .Values.beads.service.httpPort | default 8080 -}}
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: {{ $fullname }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gasboat.beads.labels" . | nindent 4 }}
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: Host(`{{ $host }}`)
      kind: Rule
      services:
        - name: {{ $fullname }}
          port: {{ $httpPort }}
      {{- if or .Values.beads.ingress.ipWhitelist.enabled .Values.beads.ingress.rateLimit.enabled }}
      middlewares:
        {{- if .Values.beads.ingress.ipWhitelist.enabled }}
        - name: {{ $fullname }}-ipwhitelist
        {{- end }}
        {{- if .Values.beads.ingress.rateLimit.enabled }}
        - name: {{ $fullname }}-ratelimit
        {{- end }}
      {{- end }}
{{- if .Values.beads.ingress.ipWhitelist.enabled }}
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: {{ $fullname }}-ipwhitelist
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gasboat.beads.labels" . | nindent 4 }}
spec:
  ipWhiteList:
    sourceRange:
      {{- toYaml .Values.beads.ingress.ipWhitelist.sourceRange | nindent 6 }}
    ipStrategy:
      depth: {{ .Values.beads.ingress.ipWhitelist.depth | default 1 }}
{{- end }}
{{- if .Values.beads.ingress.rateLimit.enabled }}
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: {{ $fullname }}-ratelimit
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gasboat.beads.labels" . | nindent 4 }}
spec:
  rateLimit:
    average: {{ .Values.beads.ingress.rateLimit.average }}
    burst: {{ .Values.beads.ingress.rateLimit.burst }}
{{- end }}
{{- end }}
